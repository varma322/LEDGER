{% extends 'tracker/base.html' %}

{% block title %}Ledger - Sourcing Tracker{% endblock %}

{% block content %}
<div class="page-header d-flex justify-content-between align-items-center">
    <div>
        <h1><i class="bi bi-journal-text me-2"></i>Ledger</h1>
        <p class="mb-0">Track all money movements and transactions</p>
    </div>
    <button class="btn btn-gradient" data-bs-toggle="modal" data-bs-target="#addTransactionModal">
        <i class="bi bi-plus-circle me-1"></i>Add Transaction
    </button>
</div>

<!-- Filter -->
<div class="card mb-4">
    <div class="card-body py-3">
        <form method="get" class="row g-3 align-items-end">
            <div class="col-md-4">
                <label class="form-label">Filter by Partner</label>
                <select name="partner" class="form-select" onchange="this.form.submit()">
                    <option value="">All Partners</option>
                    {% for partner in partners %}
                        <option value="{{ partner.id }}" {% if selected_partner == partner.id|stringformat:'s' %}selected{% endif %}>
                            {{ partner.name }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                {% if selected_partner %}
                    <a href="{% url 'ledger' %}" class="btn btn-outline-light">Clear Filter</a>
                {% endif %}
            </div>
        </form>
    </div>
</div>

<!-- Transactions Table -->
<div class="card">
    <div class="card-body p-0">
        {% if transactions %}
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Partner</th>
                        <th>Type</th>
                        <th class="text-end">Amount</th>
                        <th>Evidence</th>
                        <th>Notes</th>
                    </tr>
                </thead>
                <tbody>
                    {% for txn in transactions %}
                    <tr class="animate-fade-in">
                        <td>{{ txn.date|date:"d M Y" }}</td>
                        <td>
                            <strong>{{ txn.partner.name }}</strong>
                            <br><small class="text-muted">{{ txn.partner.gst_number }}</small>
                        </td>
                        <td>
                            {% if txn.transaction_type == 'ADVANCE_RECEIVED' %}
                                <span class="badge bg-success bg-opacity-25 text-success">
                                    <i class="bi bi-arrow-down-circle me-1"></i>Advance Received
                                </span>
                            {% else %}
                                <span class="badge bg-danger bg-opacity-25 text-danger">
                                    <i class="bi bi-arrow-up-circle me-1"></i>Refund Given
                                </span>
                            {% endif %}
                        </td>
                        <td class="text-end">
                            <strong class="{% if txn.transaction_type == 'ADVANCE_RECEIVED' %}text-success{% else %}text-danger{% endif %}">
                                {% if txn.transaction_type == 'ADVANCE_RECEIVED' %}+{% else %}-{% endif %}₹{{ txn.amount|floatformat:2 }}
                            </strong>
                        </td>
                        <td>
                            {% if txn.evidence_file %}
                                <a href="{{ txn.evidence_file.url }}" target="_blank" class="btn btn-sm btn-outline-info">
                                    <i class="bi bi-file-earmark-image"></i> View
                                </a>
                            {% else %}
                                <span class="text-muted">—</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if txn.notes %}
                                <small>{{ txn.notes|truncatewords:10 }}</small>
                            {% else %}
                                <span class="text-muted">—</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="empty-state">
            <i class="bi bi-journal"></i>
            <h5>No Transactions Yet</h5>
            <p>Record your first transaction to start tracking</p>
            <button class="btn btn-gradient" data-bs-toggle="modal" data-bs-target="#addTransactionModal">
                <i class="bi bi-plus-circle me-1"></i>Add Transaction
            </button>
        </div>
        {% endif %}
    </div>
</div>

<!-- Add Transaction Modal -->
<div class="modal fade" id="addTransactionModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header border-0">
                <h5 class="modal-title"><i class="bi bi-plus-circle me-2"></i>Record Transaction</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Partner</label>
                            {{ form.partner }}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Transaction Type</label>
                            {{ form.transaction_type }}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Amount (₹)</label>
                            {{ form.amount }}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Date</label>
                            {{ form.date }}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Evidence (Bank Screenshot)</label>
                            {{ form.evidence_file }}
                        </div>
                        <div class="col-12">
                            <label class="form-label">Notes</label>
                            {{ form.notes }}
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-gradient">
                        <i class="bi bi-check-circle me-1"></i>Record Transaction
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}
