{% extends 'tracker/base.html' %}

{% block title %}Ledger - Sourcing Tracker{% endblock %}

{% block content %}
<div class="page-header d-flex justify-content-between align-items-center">
    <div>
        <h1><i class="bi bi-journal-text me-2"></i>Ledger</h1>
        <p class="mb-0">Track all money movements and transactions</p>
    </div>
    <a href="{% url 'export_ledger_csv' %}?partner={{ selected_partner|default:'' }}&date_filter={{ date_filter|default:'' }}&start_date={{ start_date|default:'' }}&end_date={{ end_date|default:'' }}" class="btn btn-success">
        <i class="bi bi-download"></i> Export CSV
    </a>
    <button class="btn btn-gradient" data-bs-toggle="modal" data-bs-target="#addTransactionModal">
        <i class="bi bi-plus-circle me-1"></i>Add Transaction
    </button>
</div>

<!-- Filters -->
<div class="card mb-4">
    <div class="card-body py-3">
        <form method="get" class="row g-3 align-items-end" id="filterForm">
            <div class="col-md-3">
                <label class="form-label">Filter by Partner</label>
                <select name="partner" class="form-select" onchange="this.form.submit()">
                    <option value="">All Partners</option>
                    {% for partner in partners %}
                        <option value="{{ partner.id }}" {% if selected_partner == partner.id|stringformat:'s' %}selected{% endif %}>
                            {{ partner.name }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">Date Filter</label>
                <select name="date_filter" class="form-select" id="dateFilterSelect" onchange="toggleCustomDates(); this.form.submit();">
                    <option value="">All Time</option>
                    <option value="this_month" {% if date_filter == 'this_month' %}selected{% endif %}>This Month</option>
                    <option value="last_month" {% if date_filter == 'last_month' %}selected{% endif %}>Last Month</option>
                    <option value="last_3_months" {% if date_filter == 'last_3_months' %}selected{% endif %}>Last 3 Months</option>
                    <option value="custom" {% if date_filter == 'custom' %}selected{% endif %}>Custom Range</option>
                </select>
            </div>
            <div class="col-md-2 custom-date-fields" style="{% if date_filter != 'custom' %}display: none;{% endif %}">
                <label class="form-label">Start Date</label>
                <input type="date" name="start_date" class="form-control" value="{{ start_date }}">
            </div>
            <div class="col-md-2 custom-date-fields" style="{% if date_filter != 'custom' %}display: none;{% endif %}">
                <label class="form-label">End Date</label>
                <input type="date" name="end_date" class="form-control" value="{{ end_date }}">
            </div>
            <div class="col-md-1 custom-date-fields" style="{% if date_filter != 'custom' %}display: none;{% endif %}">
                <button type="submit" class="btn btn-gradient">
                    <i class="bi bi-funnel"></i>
                </button>
            </div>
            <div class="col-md-2 ms-auto text-end">
                {% if selected_partner or date_filter %}
                    <a href="{% url 'ledger' %}" class="btn btn-outline-secondary me-2">
                        <i class="bi bi-x-circle"></i> Clear
                    </a>
                {% endif %}
            </div>
        </form>
    </div>
</div>

<script>
function toggleCustomDates() {
    const select = document.getElementById('dateFilterSelect');
    const customFields = document.querySelectorAll('.custom-date-fields');
    const isCustom = select.value === 'custom';
    
    customFields.forEach(field => {
        field.style.display = isCustom ? '' : 'none';
    });
    
    // Don't auto-submit if custom is selected (user needs to pick dates first)
    if (isCustom) {
        event.stopPropagation();
        return false;
    }
}
</script>


<!-- Transactions Table -->
<div class="card">
    <div class="card-body p-0">
        {% if transactions %}
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Partner</th>
                        <th>Type</th>
                        <th class="text-end">Amount</th>
                        <th>Evidence</th>
                        <th>Notes</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for txn in transactions %}
                    <tr class="animate-fade-in">
                        <td>{{ txn.date|date:"d M Y" }}</td>
                        <td>
                            <strong>{{ txn.partner.name }}</strong>
                            <br><small class="text-muted">{{ txn.partner.gst_number }}</small>
                        </td>
                        <td>
                            {% if txn.transaction_type == 'ADVANCE_RECEIVED' %}
                                <span class="badge bg-success bg-opacity-25 text-success">
                                    <i class="bi bi-arrow-down-circle me-1"></i>Advance Received
                                </span>
                            {% else %}
                                <span class="badge bg-danger bg-opacity-25 text-danger">
                                    <i class="bi bi-arrow-up-circle me-1"></i>Refund Given
                                </span>
                            {% endif %}
                        </td>
                        <td class="text-end">
                            <strong class="{% if txn.transaction_type == 'ADVANCE_RECEIVED' %}text-success{% else %}text-danger{% endif %}">
                                {% if txn.transaction_type == 'ADVANCE_RECEIVED' %}+{% else %}-{% endif %}₹{{ txn.amount|floatformat:2 }}
                            </strong>
                        </td>
                        <td>
                            {% if txn.evidence_file %}
                                <a href="{{ txn.evidence_file.url }}" target="_blank" class="btn btn-sm btn-outline-info">
                                    <i class="bi bi-file-earmark-image"></i> View
                                </a>
                            {% else %}
                                <span class="text-muted">—</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if txn.notes %}
                                <small>{{ txn.notes|truncatewords:10 }}</small>
                            {% else %}
                                <span class="text-muted">—</span>
                            {% endif %}
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline-light" data-bs-toggle="modal" data-bs-target="#editTransactionModal{{ txn.id }}" title="Edit">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteTransactionModal{{ txn.id }}" title="Delete">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="empty-state">
            <i class="bi bi-journal"></i>
            <h5>No Transactions Yet</h5>
            <p>Record your first transaction to start tracking</p>
            <button class="btn btn-gradient" data-bs-toggle="modal" data-bs-target="#addTransactionModal">
                <i class="bi bi-plus-circle me-1"></i>Add Transaction
            </button>
        </div>
        {% endif %}
    </div>
</div>

<!-- Edit Transaction Modals (placed outside table for proper Bootstrap modal functionality) -->
{% for txn in transactions %}
<div class="modal fade" id="editTransactionModal{{ txn.id }}" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0">
                <h5 class="modal-title"><i class="bi bi-pencil me-2"></i>Edit Transaction</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="{% url 'edit_transaction' txn.id %}" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Partner</label>
                        <input type="text" class="form-control" value="{{ txn.partner.name }}" disabled>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Transaction Type</label>
                        <select name="transaction_type" class="form-select">
                            <option value="ADVANCE_RECEIVED" {% if txn.transaction_type == 'ADVANCE_RECEIVED' %}selected{% endif %}>Advance Received</option>
                            <option value="REFUND_GIVEN" {% if txn.transaction_type == 'REFUND_GIVEN' %}selected{% endif %}>Refund Given</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Amount (₹)</label>
                        <input type="number" step="0.01" name="amount" class="form-control" value="{{ txn.amount }}" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Date</label>
                        <input type="date" name="date" class="form-control" value="{{ txn.date|date:'Y-m-d' }}" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Evidence (Bank Screenshot)</label>
                        {% if txn.evidence_file %}
                            <div class="mb-2">
                                <a href="{{ txn.evidence_file.url }}" target="_blank" class="btn btn-sm btn-outline-info">
                                    <i class="bi bi-file-earmark-image"></i> Current Evidence
                                </a>
                            </div>
                        {% endif %}
                        <input type="file" name="evidence_file" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Notes</label>
                        <textarea name="notes" class="form-control" rows="2">{{ txn.notes }}</textarea>
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-gradient">
                        <i class="bi bi-check-circle me-1"></i>Update Transaction
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteTransactionModal{{ txn.id }}" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0">
                <h5 class="modal-title"><i class="bi bi-exclamation-triangle me-2 text-danger"></i>Delete Transaction</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this transaction?</p>
                <div class="card bg-dark">
                    <div class="card-body">
                        <strong>{{ txn.partner.name }}</strong><br>
                        <span class="{% if txn.transaction_type == 'ADVANCE_RECEIVED' %}text-success{% else %}text-danger{% endif %}">
                            {{ txn.get_transaction_type_display }} - ₹{{ txn.amount|floatformat:2 }}
                        </span><br>
                        <small class="text-muted">{{ txn.date|date:"d M Y" }}</small>
                    </div>
                </div>
                <p class="text-warning mt-3"><i class="bi bi-exclamation-circle me-1"></i>This action cannot be undone. The partner balance will be adjusted accordingly.</p>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">Cancel</button>
                <form method="post" action="{% url 'delete_transaction' txn.id %}" class="d-inline">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-trash me-1"></i>Delete Transaction
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endfor %}

<!-- Add Transaction Modal -->
<div class="modal fade" id="addTransactionModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header border-0">
                <h5 class="modal-title"><i class="bi bi-plus-circle me-2"></i>Record Transaction</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Partner</label>
                            {{ form.partner }}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Transaction Type</label>
                            {{ form.transaction_type }}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Amount (₹)</label>
                            {{ form.amount }}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Date</label>
                            {{ form.date }}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Evidence (Bank Screenshot)</label>
                            {{ form.evidence_file }}
                        </div>
                        <div class="col-12">
                            <label class="form-label">Notes</label>
                            {{ form.notes }}
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-gradient">
                        <i class="bi bi-check-circle me-1"></i>Record Transaction
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}
